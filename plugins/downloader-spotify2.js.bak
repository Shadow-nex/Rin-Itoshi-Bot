import fetch from "node-fetch";

let handler = async (m, { conn, args, usedPrefix, command }) => {
  if (!args[0]) return m.reply(`❌ Ingresa un enlace de Spotify.\n\nEjemplo:\n${usedPrefix + command} https://open.spotify.com/track/4uLU6hMCjMI75M1A2tKUQC`);

  await m.react('🎵');
  
  try {
    let url = `https://api.spotifydown.com/download?url=${encodeURIComponent(args[0])}`;
    let res = await fetch(url);
    let json = await res.json();

    if (!json.status) return m.reply("⚠️ No se pudo descargar la canción.");

    let caption = `
╭━━━〔 *Descarga Spotify* 〕━━⬣
┃ 🎶 *Título:* ${json.title}
┃ 👤 *Artista:* ${json.artist}
╰━━━━━━━━━━━━━━━━⬣
    `;

    // Enviar carátula + info
    await conn.sendFile(m.chat, json.cover, 'cover.jpg', caption, m);

    // Enviar archivo de música
    await conn.sendFile(m.chat, json.download, `${json.title}.mp3`, caption, m, false, {
      mimetype: 'audio/mpeg'
    });

  } catch (e) {
    console.error(e);
    m.reply("❌ Error al descargar la canción.");
  }
};

handler.help = ['spotify'];
handler.tags = ['downloader'];
handler.command = /^spotify(dl)?$/i;

export default handler;