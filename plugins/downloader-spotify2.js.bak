import fetch from "node-fetch";

let handler = async (m, { conn, args, usedPrefix, command }) => {
  if (!args[0]) return m.reply(`âŒ Ingresa un enlace de Spotify.\n\nEjemplo:\n${usedPrefix + command} https://open.spotify.com/track/4uLU6hMCjMI75M1A2tKUQC`);

  await m.react('ğŸµ');
  
  try {
    let url = `https://api.spotifydown.com/download?url=${encodeURIComponent(args[0])}`;
    let res = await fetch(url);
    let json = await res.json();

    if (!json.status) return m.reply("âš ï¸ No se pudo descargar la canciÃ³n.");

    let caption = `
â•­â”â”â”ã€” *Descarga Spotify* ã€•â”â”â¬£
â”ƒ ğŸ¶ *TÃ­tulo:* ${json.title}
â”ƒ ğŸ‘¤ *Artista:* ${json.artist}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â¬£
    `;

    // Enviar carÃ¡tula + info
    await conn.sendFile(m.chat, json.cover, 'cover.jpg', caption, m);

    // Enviar archivo de mÃºsica
    await conn.sendFile(m.chat, json.download, `${json.title}.mp3`, caption, m, false, {
      mimetype: 'audio/mpeg'
    });

  } catch (e) {
    console.error(e);
    m.reply("âŒ Error al descargar la canciÃ³n.");
  }
};

handler.help = ['spotify'];
handler.tags = ['downloader'];
handler.command = /^spotify(dl)?$/i;

export default handler;