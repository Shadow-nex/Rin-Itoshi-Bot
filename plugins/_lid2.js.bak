import moment from 'moment-timezone';

let handler = async (m, { conn, args, usedPrefix, command }) => {
  try {
    let number;

    if (m.quoted?.sender) {
      number = m.quoted.sender;
    } 
    else if (m.mentionedJid?.length) {
      number = m.mentionedJid[0];
    } 
    else if (args[0]) {
      let raw = args[0].replace(/\D/g, ''); 
      if (raw.length < 8) {
        return conn.reply(m.chat, `ğŸš© *NÃºmero invÃ¡lido, revisa bien.*`, m, fake);
      }
      number = raw + '@s.whatsapp.net';
    } 
    else {
      return conn.reply(
        m.chat,
        `ğŸ *Usa el comando asÃ­:*\n\nâ”Œ ğ˜Œğ˜«ğ˜¦ğ˜®ğ˜±ğ˜­ğ˜°:\nâ”œ ${usedPrefix + command} +51999999999\nâ”œ ${usedPrefix + command} @usuario\nâ”” Responde a un mensaje`,
        m,
        fake
      );
    }

    let exists = await conn.onWhatsApp(number);
    if (!exists?.length) {
      return conn.reply(m.chat, 'âŒ *Ese nÃºmero no estÃ¡ registrado en WhatsApp.*', m, fake);
    }

    let user = exists[0];
    if (!user?.jid || !user?.lid) {
      return conn.reply(m.chat, 'âŒ *No se pudo obtener el LID.*', m, fake);
    }

    let name = await conn.getName(user.jid).catch(() => null);

    let isOwner = ['51919199620@s.whatsapp.net'].includes(user.jid);
    let tipoCuenta = user.biz ?? false ? 'ğŸ“¦ *Business*' : 'ğŸ™â€â™‚ï¸ *Personal*';

    let fecha = moment().tz('America/Lima').format('DD/MM/YYYY');
    let hora = moment().tz('America/Lima').format('HH:mm:ss');

    let texto = `
â•­â”â”â”ã€” *âš¡ WHATSAPP LID* ã€•â”â”â¬£
â”ƒ âœ¨ *Nombre:* ${name ?? 'No disponible'}
â”ƒ ğŸ”– *NÃºmero:* wa.me/${user.jid.replace(/\D/g, '')}
â”ƒ ğŸ§© *LID:* ${user.lid}
â”ƒ ğŸ·ï¸ *Cuenta:* ${tipoCuenta}
â”ƒ ğŸ‘‘ *Es Owner?* ${isOwner ? 'âœ… SÃ­' : 'âŒ No'}
â”ƒ ğŸ“… *Fecha:* ${fecha}
â”ƒ â° *Hora:* ${hora}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â¬£`;

    await conn.reply(m.chat, texto, m, fake);

  } catch (e) {
    console.error('Error en comando lid:', e);
    conn.reply(m.chat, 'âŒ *OcurriÃ³ un error inesperado al obtener el LID.*', m, fake);
  }
};

handler.command = ['lid'];
handler.help = ['lid'];
handler.tags = ['tools'];

export default handler;