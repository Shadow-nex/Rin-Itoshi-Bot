import fetch from 'node-fetch'

const CONFIG = {
  API: 'https://api.vreden.my.id/api/fbdl',
  CMD: ['fbdl', 'fb2', 'facebook2'],
  TIMEOUT: 60000
}

const handler = async (m, { conn, args, usedPrefix, command }) => {
  if (!args[0]) {
    return conn.reply(m.chat, 
      `âœ¨ *Downloader FB HD*\n\n` +
      `ğŸ‘‰ Ingresa el enlace de Facebook a descargar.\n` +
      `Ejemplo:\n${usedPrefix + command} https://www.facebook.com/share/r/XXXXXX`, 
    m)
  }

  const url = args[0]
  await m.react('ğŸ•’')

  try {
    const res = await fetch(`${CONFIG.API}?url=${encodeURIComponent(url)}`, { timeout: CONFIG.TIMEOUT })
    if (!res.ok) throw new Error(`Error HTTP ${res.status}`)
    const json = await res.json()

    if (!json?.data?.status) throw new Error('No se encontrÃ³ el video ğŸ˜¢')

    const { title, hd_url, sd_url } = json.data
    const video = hd_url || sd_url
    if (!video) throw new Error('El API no devolviÃ³ ningÃºn link de video.')

    // ğŸ”¹ Mensaje decorado
    const caption = 
`â•­â”â”â”ã€” ğŸ“¥ *FACEBOOK DL* ã€•â”â”â¬£
â”ƒ âœ¨ *TÃ­tulo:* ${title || 'Sin tÃ­tulo'}
â”ƒ ğŸ *Calidad:* ${hd_url ? 'HD' : 'SD'}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â¬£`

    // ğŸ”¹ EnvÃ­o del archivo
    await conn.sendMessage(m.chat, { 
      video: { url: video },
      caption,
      mimetype: 'video/mp4',
      fileName: `${(title || 'facebook').slice(0, 80)}.mp4`
    }, { quoted: m })

    await m.react('âœ…')

  } catch (e) {
    console.error(e)
    await m.react('âŒ')
    conn.reply(m.chat, `âš ï¸ Error al descargar:\n${e.message}`, m)
  }
}

handler.help = ['fbdl <url>']
handler.tags = ['downloader']
handler.command = new RegExp(`^(${CONFIG.CMD.join('|')})$`, 'i')

export default handler