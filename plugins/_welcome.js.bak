/*import { WAMessageStubType } from '@whiskeysockets/baileys'
import fetch from 'node-fetch'

export async function before(m, { conn, participants, groupMetadata }) {
    if (!m.messageStubType || !m.isGroup) return true

    // --- FUNCIONES AUXILIARES ---
    const getPais = (numero) => {
        const paisesPorPrefijo = {
            "1": "ğŸ‡ºğŸ‡¸ Estados Unidos",
            "34": "ğŸ‡ªğŸ‡¸ EspaÃ±a",
            "52": "ğŸ‡²ğŸ‡½ MÃ©xico",
            "54": "ğŸ‡¦ğŸ‡· Argentina",
            "55": "ğŸ‡§ğŸ‡· Brasil",
            "56": "ğŸ‡¨ğŸ‡± Chile",
            "57": "ğŸ‡¨ğŸ‡´ Colombia",
            "58": "ğŸ‡»ğŸ‡ª Venezuela",
            "591": "ğŸ‡§ğŸ‡´ Bolivia",
            "593": "ğŸ‡ªğŸ‡¨ Ecuador",
            "595": "ğŸ‡µğŸ‡¾ Paraguay",
            "598": "ğŸ‡ºğŸ‡¾ Uruguay",
            "502": "ğŸ‡¬ğŸ‡¹ Guatemala",
            "503": "ğŸ‡¸ğŸ‡» El Salvador",
            "504": "ğŸ‡­ğŸ‡³ Honduras",
            "505": "ğŸ‡³ğŸ‡® Nicaragua",
            "506": "ğŸ‡¨ğŸ‡· Costa Rica",
            "507": "ğŸ‡µğŸ‡¦ PanamÃ¡",
            "51": "ğŸ‡µğŸ‡ª PerÃº",
            "53": "ğŸ‡¨ğŸ‡º Cuba",
            "91": "ğŸ‡®ğŸ‡³ India"
        }
        const numeroLimpio = numero.replace(/\D/g,'') 
        for (let i = 1; i <= 3; i++) {
            const prefijo = numeroLimpio.slice(0, i)
            if (paisesPorPrefijo[prefijo]) return paisesPorPrefijo[prefijo]
        }
        return "ğŸŒ Desconocido"
    }

    const getTimeZone = (numero) => {
        const zonasHorarias = {
            "1": "America/New_York",
            "34": "Europe/Madrid",
            "52": "America/Mexico_City",
            "54": "America/Argentina/Buenos_Aires",
            "55": "America/Sao_Paulo",
            "56": "America/Santiago",
            "57": "America/Bogota",
            "58": "America/Caracas",
            "591": "America/La_Paz",
            "593": "America/Guayaquil",
            "595": "America/Asuncion",
            "598": "America/Montevideo",
            "502": "America/Guatemala",
            "503": "America/El_Salvador",
            "504": "America/Tegucigalpa",
            "505": "America/Managua",
            "506": "America/Costa_Rica",
            "507": "America/Panama",
            "51": "America/Lima",
            "53": "America/Havana",
            "91": "Asia/Kolkata"
        }
        const numeroLimpio = numero.replace(/\D/g,'')
        for (let i = 1; i <= 3; i++) {
            const prefijo = numeroLimpio.slice(0, i)
            if (zonasHorarias[prefijo]) return zonasHorarias[prefijo]
        }
        return "America/Lima"
    }

    const numeroUsuario = m.key.participant?.split('@')[0].replace(/\D/g,'')
    if (!numeroUsuario) return
    const pais = getPais(numeroUsuario)
    const zona = getTimeZone(numeroUsuario)

    const thumbRes = await fetch("https://files.catbox.moe/jkw74m.jpg")
    const thumbBuffer = await thumbRes.buffer()
    const fkontak = {
        key: { participants: "0@s.whatsapp.net", remoteJid: "status@broadcast", fromMe: false, id: "Halo" },
        message: { locationMessage: { name: `(â˜† RIN ITOSHI ULTRA â˜†) â­`, jpegThumbnail: thumbBuffer } },
        participant: "0@s.whatsapp.net"
    }

    let ppUrl = await conn.profilePictureUrl(m.messageStubParameters[0] || m.key.participant, 'image')
        .catch(_ => 'https://raw.githubusercontent.com/The-King-Destroy/Adiciones/main/Contenido/1745522645448.jpeg')

    let chat = global.db.data.chats[m.chat]
    let groupSize = participants.length
    if (m.messageStubType == 27) groupSize++         
    else if (m.messageStubType == 28 || m.messageStubType == 32) groupSize--

    let fechaObj = new Date()
    let hora = fechaObj.toLocaleTimeString('es-PE', { timeZone: zona, hour: '2-digit', minute: '2-digit' })
    let fecha = fechaObj.toLocaleDateString('es-PE', { day: 'numeric', month: 'long', year: 'numeric', timeZone: zona })
    let dia = fechaObj.toLocaleDateString('es-PE', { weekday: 'long', timeZone: zona })

    // --- MENSAJE BIENVENIDA ---
    if (chat.welcome && m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_ADD) {
        // Usamos el nÃºmero limpio
        const entranteNumero = String(m.participants?.[0] || m.key.participant).split('@')[0].replace(/\D/g,'')
        let welcomeMessage = `*ğŸŒ¸â”â”âœ¦ WELCOME âœ¦â”â”ğŸŒ¸*\n
âœ¨ Â¡@${entranteNumero}, un nuevo nakama ha llegado al clan! âš”ï¸
ğŸŒ Grupo: *${groupMetadata.subject}*
ğŸ“… Fecha: ${dia}, ${fecha}
â° Hora: ${hora}
ğŸŒ PaÃ­s: ${getPais(entranteNumero)}
ğŸ‘¥ Miembros: ${groupSize}

ğŸŒŸ Â¡Prepara tus poderes y que comience la aventura! ğŸ‰
ğŸ’¬ Recuerda saludar a todos y compartir tu energÃ­a positiva ğŸ’–
`
        const fakeContext = {
            contextInfo: {
                isForwarded: true,
                forwardedNewsletterMessageInfo: { newsletterJid: "120363401008003732@newsletter", serverMessageId: '', newsletterName: "â‚Šê’°âœ© RIN ITOSHI BOT âœ¿" },
                externalAdReply: { title: "â˜† Rin Itoshi Bot â˜†", body: "Desarrollado x ShadowCore", mediaUrl: null, description: null, previewType: "PHOTO", thumbnailUrl: ppUrl, sourceUrl: "https://instagram.com", mediaType: 1, renderLargerThumbnail: false },
                mentionedJid: [entranteNumero + "@s.whatsapp.net"]
            }
        }
        await conn.sendMessage(m.chat, { image: { url: ppUrl }, caption: welcomeMessage, ...fakeContext }, { quoted: fkontak })
    }

    // --- MENSAJE DESPEDIDA ---
    if (chat.welcome && (m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_LEAVE || m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_REMOVE)) {
        // Para salidas usamos m.participants[0] que garantiza el nÃºmero real
        const eliminadoNumero = String(m.participants?.[0] || m.key.participant).split('@')[0].replace(/\D/g,'')
        let byeMessage = `*ğŸ’”â”â”âœ¦ GOODBYE âœ¦â”â”ğŸ’”*\n
ğŸ˜¢ @${eliminadoNumero} ha sido eliminado del grupo *${groupMetadata.subject}*.
ğŸ“… Fecha: ${dia}, ${fecha}
â° Hora: ${hora}
ğŸŒ PaÃ­s: ${getPais(eliminadoNumero)}
ğŸ‘¥ Miembros restantes: ${groupSize}

ğŸ•Šï¸ Que tus caminos sean Ã©picos, nakama ğŸŒ¸
âš¡ Â¡Siempre serÃ¡s parte de nuestra historia! âœ¨
`
        const fakeContext = {
            contextInfo: {
                isForwarded: true,
                forwardedNewsletterMessageInfo: { newsletterJid: "120363401008003732@newsletter", serverMessageId: '', newsletterName: "â‚Šê’°âœ© RIN ITOSHI BOT âœ¿" },
                externalAdReply: { title: "â˜† Rin Itoshi Bot â˜†", body: "Desarrollado x ShadowCore", mediaUrl: null, description: null, previewType: "PHOTO", thumbnailUrl: ppUrl, sourceUrl: "https://instagram.com", mediaType: 1, renderLargerThumbnail: false },
                mentionedJid: [eliminadoNumero + "@s.whatsapp.net"]
            }
        }
        await conn.sendMessage(m.chat, { image: { url: ppUrl }, caption: byeMessage, ...fakeContext }, { quoted: fkontak })
    }
}
*/

import { WAMessageStubType } from '@whiskeysockets/baileys';

export async function before(m, { conn, participants, groupMetadata }) {
  if (!m.messageStubType || !m.isGroup) return true;

  const chat = globalThis.db.data.chats[m.chat];
  const nombre = globalThis.db.data.users[m.messageStubParameters[0]]?.name || {};
  const botId = conn.user.jid;

  const ppUrl = await conn.profilePictureUrl(m.messageStubParameters[0], 'image')
    .catch(() => "https://stellarwa.xyz/files/1752115005119.jpg");

  const name = nombre || conn.getName(m.messageStubParameters[0]);
  const actionUser = m.key.participant ? await conn.getName(m.key.participant) : null;

  const actionMessages = {
    [WAMessageStubType.GROUP_PARTICIPANT_ADD]: actionUser ? `\nâ”Šâ¤ *Agregado por â€º* @${m.key.participant.split`@`[0]}` : '',
    [WAMessageStubType.GROUP_PARTICIPANT_REMOVE]: actionUser ? `\nâ”Šâ¤ *Eliminado por â€º* @${m.key.participant.split`@`[0]}` : '',
    [WAMessageStubType.GROUP_PARTICIPANT_LEAVE]: ''
  };

  const userss = m.messageStubParameters[0];
  const formatText = (template, memberCount) => {
    return template
      .replace('@user', `@${userss.split`@`[0]}`)
      .replace('@group', groupMetadata.subject)
      .replace('@date', new Date().toLocaleString())
      .replace('@users', `${memberCount}`)
      .replace('@type', actionMessages[m.messageStubType])
      .replace('@desc', groupMetadata.desc?.toString() || 'âœ¿ Sin Desc âœ¿');
  };

  let memberCount = participants.length;
  if (m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_ADD) memberCount += 1;
  else if ([WAMessageStubType.GROUP_PARTICIPANT_REMOVE, WAMessageStubType.GROUP_PARTICIPANT_LEAVE].includes(m.messageStubType)) memberCount -= 1;

const welcomeMessage = formatText(chat.sWelcome || `â•­â”ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—¯â—
â”Šã€Œ *Bienvenido* ğŸ¤— ã€
â”Š  *Nombre:* @user
â”Š  *Grupo:* @group
â”Šâ”ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—¯â— @type
â”Šâ¤ *Usa .menu para ver los* 
â”Š *comandos.*
â”Šâ¤ *Ahora somos @users miembros.*
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—¯`, memberCount);

  const byeMessage = formatText(chat.sBye || `â•­â”ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—¯â—
â”Šã€Œ *Hasta pronto ğŸ‘‹* ã€
â”Š  *Nombre:* @user
â”Šâ”ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—¯â— @type
â”Šâ¤ *OjalÃ¡ que vuelva pronto.*
â”Šâ¤ *Ahora somos @users miembros.*
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—¯`, memberCount);

  const leaveMessage = formatText(chat.sBye || byeMessage, memberCount);
  const mentions = [userss, m.key.participant];

  const fakeContext = {
    contextInfo: {
      isForwarded: true,
      forwardedNewsletterMessageInfo: {
        newsletterJid: "120363422169517881@newsletter",
        serverMessageId: '',
        newsletterName: "MagnosBot| CHANNEL"
      },
      externalAdReply: {
        title: packname,
        body: dev,
        mediaUrl: null,
        description: null,
        previewType: "PHOTO",
        thumbnailUrl: icon,
        sourceUrl: redes,
        mediaType: 1,
        renderLargerThumbnail: false
      },
      mentionedJid: mentions
    }
  };

        if (chat.welcome && m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_ADD) {
    let caption = welcomeMessage;
    await conn.sendMessage(m.chat, { image: { url: ppUrl }, caption, ...fakeContext });
  }

        if (chat.welcome && m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_LEAVE) {
    let caption = byeMessage;
    await conn.sendMessage(m.chat, { image: { url: ppUrl }, caption, ...fakeContext });
  }
        if (chat.welcome && m.messageStubType === WAMessageStubType.GROUP_PARTICIPANT_REMOVE) {
    let caption = welcomeMessage;
    await conn.sendMessage(m.chat, { image: { url: ppUrl }, caption, ...fakeContext });
  }
}