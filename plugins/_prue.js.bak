import yts from 'yt-search';
import { proto } from '@whiskeysockets/baileys';

let handler = async (m, { conn, usedPrefix }) => {
  try {
    // Obtener cualquier texto posible del mensaje
    let text =
      m.message?.conversation ||
      m.message?.extendedTextMessage?.text ||
      m.message?.imageMessage?.caption ||
      m.message?.videoMessage?.caption ||
      "";

    if (!text) return; // No hay texto, salir

    // Detectar link de YouTube
    let regex = /(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/[^\s]+/i;
    let match = text.match(regex);
    if (!match) return; // No es link de YouTube

    let url = match[0];

    // ReacciÃ³n de carga
    await conn.sendMessage(m.chat, { react: { text: 'â³', key: m.key } });

    // Buscar info del video
    let searchResult = await yts(url);
    let video = searchResult.videos[0];
    if (!video) {
      await conn.sendMessage(m.chat, { react: { text: 'âŒ', key: m.key } });
      return conn.sendMessage(m.chat, { text: 'âŒ No se encontrÃ³ el video.' }, { quoted: m });
    }

    // ReacciÃ³n de info obtenida
    await conn.sendMessage(m.chat, { react: { text: 'ğŸ“¥', key: m.key } });

    // Preparar lista de descarga
    const sections = [
      {
        title: "ğŸµ FORMATOS DISPONIBLES",
        rows: [
          { title: "ğŸµ YTMP3", description: "Descargar solo audio", rowId: `#ytmp3 ${video.url}` },
          { title: "ğŸ¬ YTMP4", description: "Descargar video", rowId: `#ytmp4 ${video.url}` },
          { title: "ğŸ§ YTA", description: "Audio alta calidad", rowId: `#yta ${video.url}` },
          { title: "ğŸ“¹ YTV", description: "Video alta calidad", rowId: `#ytv ${video.url}` },
        ]
      }
    ];

    const listMessage = {
      text: `â•­â”â”â”ã€” ğŸ¶ YOUTUBE DETECTADO ã€•â”â”â¬£
> ğŸ¬ TÃ­tulo: ${video.title}
> â±ï¸ DuraciÃ³n: ${video.timestamp}
> ğŸ‘ï¸ Vistas: ${video.views}
> ğŸ”— Enlace: ${video.url}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â¬£

Selecciona el formato que deseas descargar:`,
      footer: "Kaneki Bot â€¢ YouTube Downloader",
      title: "ğŸ“¥ DESCARGA TU VIDEO",
      buttonText: "Seleccionar formato",
      sections
    };

    // Enviar mensaje con miniatura y lista
    await conn.sendMessage(m.chat, {
      image: { url: video.thumbnail },
      ...listMessage
    }, { quoted: m });

    // ReacciÃ³n de listo
    await conn.sendMessage(m.chat, { react: { text: 'âœ”ï¸', key: m.key } });

  } catch (err) {
    console.error(err);
    // ReacciÃ³n de error
    await conn.sendMessage(m.chat, { react: { text: 'âŒ', key: m.key } });
    conn.sendMessage(m.chat, { text: 'âŒ OcurriÃ³ un error al procesar el video de YouTube.' }, { quoted: m });
  }
};

// Detecta automÃ¡ticamente cualquier link de YouTube
handler.customPrefix = /(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/[^\s]+/i;
handler.command = new RegExp();
export default handler;