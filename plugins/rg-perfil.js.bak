import moment from 'moment-timezone';
import PhoneNumber from 'awesome-phonenumber';
import fetch from 'node-fetch';
import { xpRange } from '../lib/levelling.js';

let handler = async (m, { conn, args, usedPrefix }) => {
    try {

        let userId;
        if (m.quoted && m.quoted.sender) userId = m.quoted.sender;
        else if (m.mentionedJid && m.mentionedJid.length > 0) userId = m.mentionedJid[0];
        else userId = m.sender;

        if (!global.db.data.users) global.db.data.users = {};
        if (!global.db.data.characters) global.db.data.characters = {};
        if (!global.db.data.users[userId]) global.db.data.users[userId] = {};
        const user = global.db.data.users[userId];

        let name = await conn.getName(userId).catch(() => userId.split('@')[0]);
        let cumpleanos = user.birth || 'Sin especificar :< (#setbirth)';
        let genero = user.genre || 'Sin especificar';
        let pareja = user.marry;
        let casado = pareja ? (global.db.data.users[pareja]?.name || await conn.getName(pareja).catch(() => pareja.split('@')[0])) : 'Nadie';
        let description = user.description || 'Sin descripciÃ³n :v';
        let exp = user.exp || 0;
        let nivel = user.level || 0;
        let coin = user.coin || 0;
        let bank = user.bank || 0;
        let totalCoins = coin + bank;
        let country = user.country || 'Desconocido';
        let phone = new PhoneNumber(userId, 'PE').getNumber('international');

        const sorted = Object.entries(global.db.data.users)
            .map(([k, v]) => ({ ...v, jid: k }))
            .sort((a, b) => (b.level || 0) - (a.level || 0));
        const rank = sorted.findIndex(u => u.jid === userId) + 1;
        const xpData = xpRange(nivel, global.multiplier);
        const progreso = `${exp - xpData.min} => ${xpData.xp} _(${Math.floor(((exp - xpData.min) / xpData.xp) * 100)}%)_`;

        const premium = user.premium || global.prems.map(v => v.replace(/\D+/g, '') + '@s.whatsapp.net').includes(userId);
        const isLeft = premium ? (global.prems.includes(userId.split('@')[0]) ? 'Permanente' : (user.premiumTime ? await formatTime(user.premiumTime - Date.now()) : 'â€”')) : 'â€”';

        const favId = user.favorite;
        const favLine = favId && global.db.data.characters?.[favId] ? `\nà¹‘ Claim favorito Â» *${global.db.data.characters[favId].name || '???'}*` : '';
        const ownedIDs = Object.entries(global.db.data.characters).filter(([, c]) => c.user === userId).map(([id]) => id);
        const haremCount = ownedIDs.length;
        const haremValue = ownedIDs.reduce((acc, id) => {
            const char = global.db.data.characters[id] || {};
            const value = typeof char.value === 'number' ? char.value : 0;
            return acc + value;
        }, 0);

        const perfil = await conn.profilePictureUrl(userId, 'image')
            .catch(_ => 'https://raw.githubusercontent.com/The-King-Destroy/Adiciones/main/Contenido/1745522645448.jpeg');

        const profileText = `
      ðŸ”® ðð„ð‘ð…ðˆð‹ ð‚ðŽð’ðŒðˆð‚ðŽ ðŸ”®
   âœ§ Ëšâ‚Š âŠ¹ Rin Itoshi Bot âŠ¹ â‚ŠËš âœ§

ðŸŒŸ *Identidad Estelar:* @${userId.split('@')[0]}
ðŸŒ™ *Nombre Arcano:* ${name}
ðŸŒ€ *Esencia Vital:* _${description}_

âš™ï¸ ð‚ðŽðð…ðˆð†ð”ð‘ð€ð‚ðˆðŽð ð„ð’ððˆð‘ðˆð“ð”ð€ð‹
ðŸŽ‚ *Edad Estelar:* ${user.age || 'Incierta'}
ðŸ“† *Ciclo CÃ³smico:* ${cumpleanos}
âš§ï¸ *Polaridad:* ${genero}
ðŸ’– *VÃ­nculo Ãlmico:* ${casado}
ðŸŒ *Origen Estelar:* ${country}
ðŸ“± *Contacto:* ${phone}

âœ¦ ð‘ð„ð‚ð”ð‘ð’ðŽð’ âœ¦
ðŸª™ *Monedas CÃ³smicas:* ${coin.toLocaleString()}
ðŸ¦ *Banco CÃ³smico:* ${bank.toLocaleString()}
ðŸŒ· *Nivel Dimensional:* ${nivel}
ðŸŒ¿ *Exp CÃ³smica:* ${exp.toLocaleString()}
âž¨ Progreso Â» *${progreso}*
# Puesto Â» *#${rank}*
ðŸ›¡ï¸ *Rango:* ${user.role || 'Sin Rango'}
ðŸ”® *Premium CÃ³smico:* ${premium ? `ðŸŸ¢ Activo (*${isLeft}*)` : 'ðŸ”´ Inactivo'}

ê•¥ Harem Â» *${haremCount}*
â™¤ Valor total Â» *${haremValue.toLocaleString()}*${favLine}
â’ Coins totales Â» *${totalCoins.toLocaleString()}*
â’ Comandos totales Â» *${user.commands || 0}*
`;

        await conn.sendMessage(m.chat, {
            image: { url: perfil },
            caption: profileText.trim(),
            mentions: [userId],
            contextInfo: {
                externalAdReply: {
                    title: 'âœ§ Perfil CÃ³smico âœ§',
                    body: '',
                    thumbnailUrl: perfil,
                    mediaType: 1,
                    showAdAttribution: true,
                    renderLargerThumbnail: true
                }
            }
        }, { quoted: m });
}

handler.help = ['profile'];
handler.tags = ['rg'];
handler.command = ['profile', 'perfil'];
handler.group = true;

export default handler;

async function formatTime(ms) {
    let s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60), d = Math.floor(h / 24);
    let months = Math.floor(d / 30), weeks = Math.floor((d % 30) / 7);
    s %= 60; m %= 60; h %= 24; d %= 7;
    let t = months ? [`${months} mes${months > 1 ? 'es' : ''}`] :
            weeks ? [`${weeks} semana${weeks > 1 ? 's' : ''}`] :
            d ? [`${d} dÃ­a${d > 1 ? 's' : ''}`] : [];
    if (h) t.push(`${h} hora${h > 1 ? 's' : ''}`);
    if (m) t.push(`${m} minuto${m > 1 ? 's' : ''}`);
    if (s) t.push(`${s} segundo${s > 1 ? 's' : ''}`);
    return t.length > 1 ? t.slice(0, -1).join(' ') + ' y ' + t.slice(-1) : t[0];
}